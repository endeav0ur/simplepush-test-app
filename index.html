<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache">
    <title>Push</title>

    <style>
      html, body {
        width: 100%;
        height: 100%;
        background-color: gray;
      }
    </style>

    <script>
/*
      navigator.mozSetMessageHandler('push', function(e) {
        var notification = window.navigator.mozNotification.createNotification('Push notification', 'From the template application');
      
        notification.onclick = function test_notificationClick() {
          alert("Got system message! ");
        };
      
        notification.show();
      });

*/
      function updateNotifications() {

        function createRegistrationUI(registration) {

            var button = document.createElement("button");
            var t   = document.createTextNode("Unregister");
            button.appendChild(t);

            button.addEventListener('click', function() {
                var r = navigator.pushRegistrationManager.unregister();
                r.onsuccess = function(e) {updateNotifications();};
                r.onerror   = function(e) {alert("unregister failed");};
              }, false);
            
            
            var h = document.createElement("p");
            t = document.createTextNode(registration.pushEndpoint);
            h.appendChild(t);
            

            var div = document.createElement("div");
            div.appendChild(button);
            div.appendChild(h);

            return div;
        }

        document.getElementById("registrations").innerHTML = "";

        var req = navigator.pushRegistrationManager.register();
        req.onsuccess = function(e) {
          var registration = e.target.result;
          console.log(registration)
          var div = createRegistrationUI(registration);
          document.getElementById("registrations").appendChild(div);

        }
        req.onerror = function(e) {
          console.log('error')
        }
      }

      function register() {
        var req = navigator.pushRegistrationManager.register();
        console.log('request sent')
        req.onsuccess = function(e) {
          console.log('success')
          updateNotifications();
        }
        
        req.onerror = function(e) {
          alert("Registration error");
        }
      }

      function isRegistered(){
        var req = navigator.pushRegistrationManager.isRegistered();
        req.onsuccess = function(e){
          alert(e)
        }
        req.onerror = function(e){
          alert(e)
        }
      }

      function logRegistrations() {
        var req = navigator.pushRegistrationManager.register();
        req.onsuccess = function(e) {
          var registration = e.target.result;
          console.log(registration.pushEndpoint);
          
        }
      }

    </script>
  </head>

  <body onload="updateNotifications();">
    <p>Push Notifications</p>

    <button onclick="register();">Register!</button>
    <button onclick="isRegistered();">isRegistered</button>
    <button onclick="logRegistrations();">Log Registrations</button>

    <p>Registrations</p>


    <div id='registrations'>
    </div>

  </body>

</html>
